<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-contribution/tools/heap-dumps" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.0">
<title data-rh="true">Lodestar Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chainsafe.github.io/lodestar/contribution/tools/heap-dumps"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Heap Dumps | Lodestar"><meta data-rh="true" name="description" content="There are a number of reason why one would want to do a heap dump but in particular, they are helpful for find memory intensive operations and leaks. There are two major types of heap dumps that are available to node developers. The first is a JavaScript heap dump, and the second is a native heap dump. The JS heap dump is much more common and is the default heap dump that is generated by node. It is useful when analyzing JS generated objects that are managed by the runtime. However there is one major limitation to the JS heap dump, and that is that it does not include native objects. This is where the native heap dump comes in handy. The native heap dump is a snapshot of the entire process memory, and includes objects that are allocated by C/C++ code, including native modules in use by the application. The limitation to the native heap dump is that it will not include any JS objects that are allocated by the V8 runtime. Those are generally created within mmap&#x27;ed pages and the native heap dump tools are specific to C objects that are created with malloc and destroyed via free. C++ is also covered as new and delete are wrappers around malloc and free. This is why it is important to understand how to analyze both types of memory usage."><meta data-rh="true" property="og:description" content="There are a number of reason why one would want to do a heap dump but in particular, they are helpful for find memory intensive operations and leaks. There are two major types of heap dumps that are available to node developers. The first is a JavaScript heap dump, and the second is a native heap dump. The JS heap dump is much more common and is the default heap dump that is generated by node. It is useful when analyzing JS generated objects that are managed by the runtime. However there is one major limitation to the JS heap dump, and that is that it does not include native objects. This is where the native heap dump comes in handy. The native heap dump is a snapshot of the entire process memory, and includes objects that are allocated by C/C++ code, including native modules in use by the application. The limitation to the native heap dump is that it will not include any JS objects that are allocated by the V8 runtime. Those are generally created within mmap&#x27;ed pages and the native heap dump tools are specific to C objects that are created with malloc and destroyed via free. C++ is also covered as new and delete are wrappers around malloc and free. This is why it is important to understand how to analyze both types of memory usage."><link data-rh="true" rel="icon" href="/lodestar/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://chainsafe.github.io/lodestar/contribution/tools/heap-dumps"><link data-rh="true" rel="alternate" href="https://chainsafe.github.io/lodestar/contribution/tools/heap-dumps" hreflang="en"><link data-rh="true" rel="alternate" href="https://chainsafe.github.io/lodestar/contribution/tools/heap-dumps" hreflang="x-default"><script src="https://plausible.io/js/script.js" defer="defer" data-domain="chainsafe.github.io/lodestar"></script><link rel="stylesheet" href="/lodestar/assets/css/styles.79b491cb.css">
<script src="/lodestar/assets/js/runtime~main.ac65c388.js" defer="defer"></script>
<script src="/lodestar/assets/js/main.e2ca73f1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/lodestar/"><div class="navbar__logo"><img src="/lodestar/images/logo.png" alt="Lodestar Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/lodestar/images/logo.png" alt="Lodestar Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Lodestar Documentation</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ChainSafe/lodestar" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/">Home</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/security">Security Policy</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/lodestar/run/getting-started/installation">Run A Node</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/run/getting-started/installation">Install Options</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/run/getting-started/quick-start">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/run/beacon-management/starting-a-node">Beacon Node</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/run/validator-management/vc-configuration">Validator Client</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/run/logging-and-metrics/prometheus-grafana">Logging and Metrics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/run/bootnode/bootnode-cli">Discv5 Bootnode</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/lodestar/libraries/lightclient-prover/lightclient">Developer Tools</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/libraries/lightclient-prover/lightclient">Light Client</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/libraries/lightclient-prover/prover">Prover</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/supporting-libraries/">Supporting Libraries</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/lodestar/contribution/getting-started">Contributing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/contribution/advanced-topics/setting-up-a-testnet">Advanced Topics</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/depgraph">Dependency Graph</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/lodestar/contribution/dev-cli">Development Tools</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/dev-cli">CLI Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/tools/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/tools/flamegraphs">Flame Graphs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/lodestar/contribution/tools/heap-dumps">Heap Dumps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/tools/core-dumps">Core Dumps</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/contribution/testing/">Testing</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/faqs">Frequently Asked Questions</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/lodestar/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Contributing</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development Tools</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Heap Dumps</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Heap Dump Analysis</h1>
<p>There are a number of reason why one would want to do a heap dump but in particular, they are helpful for find memory intensive operations and leaks. There are two major types of heap dumps that are available to node developers. The first is a JavaScript heap dump, and the second is a native heap dump. The JS heap dump is much more common and is the default heap dump that is generated by <code>node</code>. It is useful when analyzing JS generated objects that are managed by the runtime. However there is one major limitation to the JS heap dump, and that is that it does not include native objects. This is where the native heap dump comes in handy. The native heap dump is a snapshot of the entire process memory, and includes objects that are allocated by <code>C/C++</code> code, including native modules in use by the application. The limitation to the native heap dump is that it will not include any JS objects that are allocated by the <code>V8</code> runtime. Those are generally created within <code>mmap</code>&#x27;ed pages and the native heap dump tools are specific to <code>C</code> objects that are created with <code>malloc</code> and destroyed via <code>free</code>. <code>C++</code> is also covered as <code>new</code> and <code>delete</code> are wrappers around <code>malloc</code> and <code>free</code>. This is why it is important to understand how to analyze both types of memory usage.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-heap-dump">JavaScript Heap Dump<a href="#javascript-heap-dump" class="hash-link" aria-label="Direct link to JavaScript Heap Dump" title="Direct link to JavaScript Heap Dump">​</a></h2>
<p>Node has built in <code>V8</code> heap dump access and its a very powerful tool for analyzing memory usage. Understanding how the dump is created will both help to understand how it is displayed and how to use the analysis more effectively.</p>
<p>The <code>V8</code> heap dump is a stop the world process because walking the entire heap graph is necessary to create one. This is similar to a full, major garbage collection event. The VM starts at the heap entrance node and walks the entire graph and makes note of every edge that connects each node along the way. Nodes are JSObjects and edges are references between those objects.</p>
<p>By time the whole heap is walked the full size and values of all nodes are known and all of the connections between those nodes is well understood. The object that is returned is a set of three arrays, the nodes, the edges and the string values that are encountered (because strings are themselves arrays of characters in <code>C</code> so they are treated a bit differently by <code>V8</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-v8-heap-dump">Creating a <code>V8</code> heap dump<a href="#creating-a-v8-heap-dump" class="hash-link" aria-label="Direct link to creating-a-v8-heap-dump" title="Direct link to creating-a-v8-heap-dump">​</a></h3>
<p>There are two functions for creating a heap dump but both call the same functionality under the hood. One streams the result, <code>require(&quot;v8&quot;).getHeapSnapshot([options])</code>, and is primarily intended for use by the Chrome devtools button to &quot;take a snapshot&quot;. The second writes the heap dump to a file, <code>require(&quot;v8&quot;).writeHeapSnapshot(filename[,options])</code>.</p>
<p>The optional <code>options</code> argument, in both cases, is the same and contains two props.<code>exposeInternals</code> and <code>exposeNumericValues</code> to enrich the dump. In many cases its the application layer that one wants to debug so <code>exposeInternals</code> is not usually necessary. In <code>V8</code> numbers are stored as 32bit integers and the size of pointers is also 32bits. So as an optimization, the pointer to the numeric value can be eliminated and the value itself can be stored in the <code>Address</code> of the <code>Value</code> instead. <code>exposeNumericValues</code> transcribes those &quot;pointers&quot; to the actual numeric value and appends them to the dump.</p>
<p>Because heap analysis happens frequently during Lodestar development there is a helper api endpoint to capture a heap dump. <strong>It is IMPORTANT</strong> that this endpoint is not public facing as it will open the threat of DDOS attack.</p>
<p>The endpoint accepts a <code>POST</code> request and you may include an optional <code>dirpath</code> query parameter to specify the directory where the heap dump will be written. If the <code>dirpath</code> is not specified then the heap dump will be written to the current working directory.</p>
<p>To create a Lodestar heap dump you can use the following command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-X</span><span class="token plain"> POST http://localhost:9596/eth/v1/lodestar/write_heapdump?dirpath</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/some/directory/path</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-a-v8-heap-dump">Viewing a <code>V8</code> heap dump<a href="#viewing-a-v8-heap-dump" class="hash-link" aria-label="Direct link to viewing-a-v8-heap-dump" title="Direct link to viewing-a-v8-heap-dump">​</a></h3>
<p>It is best to analyze on a local development machine so if Lodestar is running on a cloud instance download the dump to the local environment. Open Chrome, or any Chromium based browser (the example photos were taken using Brave). In the url bar type <code>chrome:://inspect</code> to bring up the DevTools menu (in brave the url will be rewritten to <code>brave://inspect</code>).</p>
<p><img decoding="async" loading="lazy" alt="DevTools" src="/lodestar/assets/images/devtools-247fdbb015a564f3376c41f4726423cc.png" width="3456" height="2234" class="img_ev3q"></p>
<p>Click on the <code>Open dedicated DevTools for Node</code> link to open the node specific window and click on the <code>Memory</code> tab as shown below.</p>
<p><img decoding="async" loading="lazy" alt="Memory Tab" src="/lodestar/assets/images/memory-tab-2606d8555ae2fc8d12d75e03d91e875f.png" width="3456" height="2234" class="img_ev3q"></p>
<p>Load the profile by either right-clicking on the left pane or by clicking the <code>Load</code> button at the bottom.</p>
<p><img decoding="async" loading="lazy" alt="Load Profile" src="/lodestar/assets/images/load-profile-1a4f5d98c15c710de58f5edccd84319f.png" width="3456" height="2234" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="analyzing-a-v8-heap-dump">Analyzing a <code>V8</code> heap dump<a href="#analyzing-a-v8-heap-dump" class="hash-link" aria-label="Direct link to analyzing-a-v8-heap-dump" title="Direct link to analyzing-a-v8-heap-dump">​</a></h3>
<p>Analysis is as much an art as it is a science and the best way to learn is to do it a few times. Generally the goal is looking for memory leaks but reducing memory overhead is also something that happens. This guide will focus on leaks. With memory leaks one is looking for why objects have references that prevent them from being garbage collected.</p>
<p>To spot sources of leaks, focus on objects that have large quantities or very large <code>retained size</code>. Retained size is the amount of memory that would be freed if the object was garbage collected. As an example if there is an object that has lots and lots of instances, like 100,000, and they are all pushed into an array then the array will have a very large retained size. This is because the array is holding references to all of the objects that it contains.</p>
<p>If it is not immediately apparent what objects are being leaked then another tool in your arsenal will be to take a second snapshot and compare it to the first. This will show what objects have been created/changed since the first snapshot.</p>
<p>If there is an object that has a large retained size but is roughly the same, but not exactly the same, changes are that is NOT the leak. Some objects can get quite large during runtime but if its roughly the same size over time, but not exactly the same, it means that the application is modifying the object (why its not exactly identical in size) but if it hasn&#x27;t grown significantly over time it can be assumed it is probably the working size of the instances.</p>
<p>Try to focus on objects that are growing in size or in number over time. Growing in size means the object is holding references to other objects and growing in number means a function closure somewhere is retaining the small instances.</p>
<p>That is the science part, but these clues are just breadcrumbs to follow. In order to actually resolve the leak, one needs to go into the code to figure out where those objects are being created, or more often, why the references to them are being retained. This is where the art comes in.</p>
<p>Having a good understanding of the codebase will help to narrow down where to look. It is also common that the leak is not coming directly from Lodestar code, but rather one of the dependencies so be careful not to rule those out.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="native-heap-dump">Native Heap Dump<a href="#native-heap-dump" class="hash-link" aria-label="Direct link to Native Heap Dump" title="Direct link to Native Heap Dump">​</a></h2>
<p><em><strong>note: collecting a native heap dump is only supported on linux, analysis can be done from linux or Mac</strong></em></p>
<p>There are several tools that can be used to do native heap dump analysis. The most common are <a href="https://valgrind.org/docs/manual/ms-manual.html" target="_blank" rel="noopener noreferrer"><code>massif</code></a> from the <a href="https://valgrind.org/" target="_blank" rel="noopener noreferrer"><code>Valgrind</code></a> suite, google&#x27;s <a href="https://github.com/gperftools/gperftools" target="_blank" rel="noopener noreferrer"><code>gperftools</code></a> and <code>heaptrack</code> from <a href="https://community.kde.org/Main_Page" target="_blank" rel="noopener noreferrer">KDE</a>. Of the three, <code>heaptrack</code> is the most user-friendly tool, and it is specifically designed for the task. It is much faster than <code>Valgrind</code>, easier to integrate than <code>gperftools</code> and also includes a gui for result analysis. Often times there are also memory allocations that are not related to memory leaks, and tools like <code>Valgrind</code> and <code>gperftools</code> become less useful. This is why <code>heaptrack</code> is the recommended tool for heap dump analysis on Lodestar.</p>
<p>There are a few things that will make the results with <code>heaptrack</code> far better. The most important is using debug builds of all libraries included in a binary, including the application itself. This will make the results usable. Not to say that they will be useless without debug symbols but it will be kinda tough to optimize functions without knowing the function names nor the file and line numbers.</p>
<p>This is the heart of what <code>heaptrack</code> will do for us. It hooks into the memory allocation and adds in stack traces for each <code>malloc</code> call site. That way every time memory is reserved there is a way to track back where it happened in the code. <code>heaptrack</code> also hooks into the <code>free</code> function and checks that versus the allocations to check for memory leaks and for temporary variables that can be optimized. This also allows for optimization of how many of each object is created by identifying high frequency allocations.</p>
<p>Generally the .heapdump file will be created on a cloud server and then copied to a local machine for analysis, mostly because the gui is not available through ssh. The gui is not required for analysis but it is much easier to use than the command line tools. The first step will be to install <code>heaptrack</code> on the target server and to capture a profile.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-collection-tools">Build collection tools<a href="#build-collection-tools" class="hash-link" aria-label="Direct link to Build collection tools" title="Direct link to Build collection tools">​</a></h3>
<p>Assume the following directory structure:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">├── beacon-node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── db</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── logs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── start-lodestar.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   └── rc-config.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── lodestar</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── </span><span class="token function" style="color:rgb(0, 0, 255)">node</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># step below will clone this repo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We will start from the directory that contains <code>lodestar</code> and the <code>beacon-node</code> files.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Install heaptrack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-y</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> heaptrack</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Using a debug build of node is recommended and it can be build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># from source. Clone the node repo to get started.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">git</span><span class="token plain"> clone https://github.com/nodejs/node.git</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Use whichever version of node you prefer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">git</span><span class="token plain"> checkout v22.1.0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ ./configure </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># This command only builds the debug version of node and assumes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># that a release version of node is already installed on the system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">make</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-C</span><span class="token plain"> out </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">BUILDTYPE</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Debug -j</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">nproc </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">--all</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Move the debug version of node the same folder that the release</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># version is installed in and name it `node_debug`.  This will put the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># debug binary on the path and allow you to run it with the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># `node_debug` command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">cp</span><span class="token plain"> out/Debug/node </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable function" style="color:rgb(0, 0, 255)">which</span><span class="token string variable" style="color:rgb(9, 134, 88)"> </span><span class="token string variable function" style="color:rgb(0, 0, 255)">node</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">_debug&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">which</span><span class="token plain"> node_debug</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/your/home/directory/.nvm/versions/node/v20.10.0/bin/node_debug</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Return to the lodestar repo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/lodestar</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Clean the build artifacts and node_modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> clean </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> clean:nm</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Install the dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Ensure that all native modules are rebuilt with debug symbols. Some</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># modules are prebuilt, like classic-level, and the debug symbols may</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># not be included. If the debugging exercise is focussed around</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># one of these dependencies, then you will need to manually clone those</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># repos and manually build them with debug symbols.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">npm</span><span class="token plain"> rebuild </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collect-a-heap-dump">Collect a heap dump<a href="#collect-a-heap-dump" class="hash-link" aria-label="Direct link to Collect a heap dump" title="Direct link to Collect a heap dump">​</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Move to th `beacon-node` directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/beacon-node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Start lodestar with profiling enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ heaptrack </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--output</span><span class="token plain"> ./lodestar.heapdump </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   node_debug </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   --max-old-space-size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/lodestar/packages/cli/bin/lodestar.js </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   beacon </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--rcConfig</span><span class="token plain"> ./rc-config.yml </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /dev/null </span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Wait some period of time for the heap dump data to be collected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># The data will not be persisted until the process is stopped. You can gracefully</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># stop the process with the following command and if you want to hard kill it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># add `-9` to the end of the `kill` command although that should not be necessary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">ps</span><span class="token plain"> aux </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> lodestar </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">awk</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;{print $2}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">head</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-n</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">xargs</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collecting-a-heap-dump-on-a-running-process">Collecting a heap dump on a running process<a href="#collecting-a-heap-dump-on-a-running-process" class="hash-link" aria-label="Direct link to Collecting a heap dump on a running process" title="Direct link to Collecting a heap dump on a running process">​</a></h3>
<p>Collecting a heap dump can also be done on a running process. There are both advantages and disadvantages to this approach. The main advantage is that you can collect a heap dump without having to restart. The down side is that the dump will only include allocations/de-allocations while the tracker is running. This means that all the non-paired calls to malloc/free will register as leaks. It will also not give a true representation of how the heap is being used. On the upside, however the dump will be much smaller in size.</p>
<p>It is important to note a warning that is in the <code>heaptrack</code> source code:</p>
<p><em>WARNING: Runtime-attaching heaptrack is UNSTABLE and can lead to CRASHES in your application, especially after you detach heaptrack again. You are hereby warned, use it at your own risk!</em></p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Move to th `beacon-node` directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/beacon-node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Start lodestar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ node_debug </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   --max-old-space-size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/lodestar/packages/cli/bin/lodestar.js </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   beacon </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--rcConfig</span><span class="token plain"> ./rc-config.yml </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$   </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /dev/null </span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Wait some period of time to start collecting the dump</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># GDB is required to inject heaptrack into a running process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># so you may need to install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-y</span><span class="token plain"> gdb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Elevated `perf` permissions are also required depending on your</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># system configuration. Change until the next reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">tee</span><span class="token plain"> /proc/sys/kernel/yama/ptrace_scope</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Get the pid of the lodestar process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">LODESTAR_PID</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">ps</span><span class="token variable" style="color:rgb(9, 134, 88)"> aux </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">grep</span><span class="token variable" style="color:rgb(9, 134, 88)"> lodestar </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">grep</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">-v</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">grep</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">awk</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable string" style="color:rgb(163, 21, 21)">&#x27;{print $2}&#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">head</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">-n</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable number" style="color:rgb(9, 134, 88)">1</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Inject heaptrack into the running process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ heaptrack </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--pid</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$LODESTAR_PID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">heaptrack output will be written to </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/home/user/beacon-node/heaptrack.node_debug.111868.zst&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/heaptrack/libheaptrack_preload.so</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">injecting heaptrack into application via GDB, this might take some time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">injection finished</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Wait some period of time to collect the heap dump. See below</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># for the termination command that can be run from a separate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># terminal when ready to stop collecting data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Terminated</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">removing heaptrack injection via GDB, this might take some time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Heaptrack finished</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"> Now run the following to investigate the data:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  heaptrack </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">--analyze</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/home/user/beacon-node/heaptrack.node_debug.111868.zst&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There is a trap in <code>heaptrack</code> but the process uses a nested shell to do the actual injection so it is not possible to just Ctrl+C out of the injected process without corrupting the output file. To properly kill the collection one needs to target the nested shell pid. Here is a helper command to target that process:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">ps</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-ef</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;[h]eaptrack --pid&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">awk</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;$3 == &#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">ps</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">-ef</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">grep</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable string" style="color:rgb(163, 21, 21)">&#x27;[h]eaptrack --pid&#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">awk</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable string" style="color:rgb(163, 21, 21)">&#x27;$3 != 1 {print $2}&#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable function" style="color:rgb(0, 0, 255)">head</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">-n</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable number" style="color:rgb(9, 134, 88)">1</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27; {print $2}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">xargs</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-r</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After working with the injected process for a while, I cannot honestly recommend it. It can work in a pinch, and is best suited for when the profiled process can be exited gracefully without repercussions (not on mainnet for instance). The benefit, though, is that the heapdump will be much smaller and targeted to runtime (will not have the transient, startup allocations) which can make it easier to see what is happening.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-heaptrack-gui-on-linux">Installing <code>heaptrack-gui</code> on Linux<a href="#installing-heaptrack-gui-on-linux" class="hash-link" aria-label="Direct link to installing-heaptrack-gui-on-linux" title="Direct link to installing-heaptrack-gui-on-linux">​</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># You can you apt, apt-get or aptitude to install the gui</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">apt-get</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-y</span><span class="token plain"> heaptrack-gui</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-heaptrack-gui-on-osx">Installing <code>heaptrack-gui</code> on OSX<a href="#installing-heaptrack-gui-on-osx" class="hash-link" aria-label="Direct link to installing-heaptrack-gui-on-osx" title="Direct link to installing-heaptrack-gui-on-osx">​</a></h3>
<p>At the time of writing this there is no official pre-built binary for OSX. This was a bit of a challenge but it was WELL worth the effort as the tool works very well. There were a number of bugs along the way while &quot;using the docs&quot; so your mileage may vary, but this is what worked for me.</p>
<p>Most of the dependencies can be installed via Homebrew and the tool itself needs to be built from source. There was one dependency that needed to be built from source. This process assumes a working folder that the repos can be cloned into.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Start in the root folder where the repos will be cloned</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ brew </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> qt@5</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># prepare tap of kde-mac/kde</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ brew tap kde-mac/kde https://invent.kde.org/packaging/homebrew-kde.git</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable" style="color:rgb(9, 134, 88)">brew </span><span class="token string variable parameter variable" style="color:rgb(9, 134, 88)">--repo</span><span class="token string variable" style="color:rgb(9, 134, 88)"> kde-mac/kde</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">/tools/do-caveats.sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># install the kde-mac and other required dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ brew </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> kde-mac/kde/kf5-kcoreaddons </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     kde-mac/kde/kf5-kitemmodels </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     kde-mac/kde/kf5-kconfigwidgets </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     kde-mac/kde/kdiagram </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     extra-cmake-modules </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     ki18n </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     threadweaver </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     boost </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     zstd </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$     gettext</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># There is a bug in the current version of kde-mac/kde and one dependency needs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># to be built manually. This is the workaround to get it built.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">git</span><span class="token plain"> clone https://invent.kde.org/frameworks/kio.git</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> kio/build</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> kio/build</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">CMAKE_PREFIX_PATH</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">brew </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token variable" style="color:rgb(9, 134, 88)"> qt@5</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ cmake </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-G</span><span class="token plain"> Ninja </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-DCMAKE_BUILD_TYPE</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Release </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ ninja</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> ninja </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Now make sure that the dependencies are available to the system during runtime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-sfv</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable" style="color:rgb(9, 134, 88)">brew </span><span class="token string variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">/share/kf5&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string environment constant" style="color:rgb(129, 31, 63)">$HOME</span><span class="token string" style="color:rgb(163, 21, 21)">/Library/Application Support&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-sfv</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable" style="color:rgb(9, 134, 88)">brew </span><span class="token string variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">/share/knotifications5&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string environment constant" style="color:rgb(129, 31, 63)">$HOME</span><span class="token string" style="color:rgb(163, 21, 21)">/Library/Application Support&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-sfv</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable" style="color:rgb(9, 134, 88)">brew </span><span class="token string variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">/share/kservices5&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string environment constant" style="color:rgb(129, 31, 63)">$HOME</span><span class="token string" style="color:rgb(163, 21, 21)">/Library/Application Support&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-sfv</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable" style="color:rgb(9, 134, 88)">brew </span><span class="token string variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)">/share/kservicetypes5&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string environment constant" style="color:rgb(129, 31, 63)">$HOME</span><span class="token string" style="color:rgb(163, 21, 21)">/Library/Application Support&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># We are now ready to build the heaptrack_gui binaries for analysis on OSX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">git</span><span class="token plain"> clone https://invent.kde.org/sdk/heaptrack.git</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> heaptrack</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">cd</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">CMAKE_PREFIX_PATH</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">brew </span><span class="token variable parameter variable" style="color:rgb(9, 134, 88)">--prefix</span><span class="token variable" style="color:rgb(9, 134, 88)"> qt@5</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:rgb(129, 31, 63)">PATH</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token environment constant" style="color:rgb(129, 31, 63)">$PATH</span><span class="token plain">:/opt/homebrew/opt/gettext/bin cmake </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ cmake </span><span class="token parameter variable" style="color:rgb(9, 134, 88)">-DCMAKE_BUILD_TYPE</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Release </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">make</span><span class="token plain"> heaptrack_gui</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">make</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># You can now find heaptrack_gui with your gui Applications. It is default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># placed as /Applications/KDE/heaptrack_gui.app</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ChainSafe/lodestar/tree/unstable/docs/pages/contribution/tools/heap-dumps.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/lodestar/contribution/tools/flamegraphs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flame Graphs</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/lodestar/contribution/tools/core-dumps"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Core Dumps</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript-heap-dump" class="table-of-contents__link toc-highlight">JavaScript Heap Dump</a><ul><li><a href="#creating-a-v8-heap-dump" class="table-of-contents__link toc-highlight">Creating a <code>V8</code> heap dump</a></li><li><a href="#viewing-a-v8-heap-dump" class="table-of-contents__link toc-highlight">Viewing a <code>V8</code> heap dump</a></li><li><a href="#analyzing-a-v8-heap-dump" class="table-of-contents__link toc-highlight">Analyzing a <code>V8</code> heap dump</a></li></ul></li><li><a href="#native-heap-dump" class="table-of-contents__link toc-highlight">Native Heap Dump</a><ul><li><a href="#build-collection-tools" class="table-of-contents__link toc-highlight">Build collection tools</a></li><li><a href="#collect-a-heap-dump" class="table-of-contents__link toc-highlight">Collect a heap dump</a></li><li><a href="#collecting-a-heap-dump-on-a-running-process" class="table-of-contents__link toc-highlight">Collecting a heap dump on a running process</a></li><li><a href="#installing-heaptrack-gui-on-linux" class="table-of-contents__link toc-highlight">Installing <code>heaptrack-gui</code> on Linux</a></li><li><a href="#installing-heaptrack-gui-on-osx" class="table-of-contents__link toc-highlight">Installing <code>heaptrack-gui</code> on OSX</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://lodestar.chainsafe.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Lodestar Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://discord.com/invite/yjyvFRP" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://x.com/lodestar_eth" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter/X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://github.com/ChainSafe/lodestar" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 ChainSafe. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>